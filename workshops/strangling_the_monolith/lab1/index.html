<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Lab - Building and Deploying a Fast-Moving Monolith | Presidio Workshops</title>

    
    
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly.min.css" />
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly-additions.min.css" />

    
    <link rel="stylesheet" href="/node_modules/highlight.js/styles/darkula.css" />

    
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/asciidoc.css" />
    <link rel="stylesheet" href="/css/custom.css" />
    
    <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery/dist/jquery.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/c3/c3.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/d3/d3.min.js"></script>

    
    
    <script src="/node_modules/patternfly/node_modules/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/drmonty-datatables-colvis/js/dataTables.colVis.js"></script>
    <script src="/node_modules/patternfly/node_modules/datatables.net-colreorder/js/dataTables.colReorder.js"></script>

    
    
    <script src="/node_modules/patternfly/dist/js/patternfly.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-combobox/js/bootstrap-combobox.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/moment/min/moment.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-select/dist/js/bootstrap-select.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-treeview/dist/bootstrap-treeview.min.js"></script>

    
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery-match-height/dist/jquery.matchHeight-min.js"></script>
    
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/clip.js"></script>
    
    <script src="/node_modules/highlight.js/lib/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body class="">
    

<nav class="navbar navbar-default navbar-inverse navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
     <a class="navbar-brand" href="/">
      <img src="img/presidio-white.png" width="150" height="auto">
      
      </a>
    </div>
    <div class="collapse navbar-collapse navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        
        
          
            <li>
              <a href="/">Home</a>
            </li>
          
        
          
            <li>
              <a href="/about/">About</a>
            </li>
          
        
          
            <li>
              <a href="/contact/">Contact</a>
            </li>
          
        
          
            <li>
              <a href="/events/">Events</a>
            </li>
          
        
          
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Workshops <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                
                  <li>
                    <a href="/workshops/agile_integrations_ci/">Agile Integrations Workshop - Citizen Integrator</a>
                  </li>
                
                  <li>
                    <a href="/workshops/agile_integrations_dev/">Agile Integrations Workshop - Developer</a>
                  </li>
                
                  <li>
                    <a href="/workshops/automation/">Automation Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/cloudforms41/">CloudForms Workshops</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_containers/">Container Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/containers_101/">Containers 101 Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/secure_software_factory/">DevSecOps Workshop - Secure Software Factory</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_kubernetes/">Kubernetes Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/kubernetes_101/">Kubernetes Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/strangling_the_monolith/">Monolith to Microservices Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/net_automation_101/">Network Automation 101 Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/selinux_policy/">SELinux Policy Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/source_to_image/">Source to Image</a>
                  </li>
                
              </ul>
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>



<div class="jumbotron jumbotron-page text-center">
  <h1>Lab - Building and Deploying a Fast-Moving Monolith</h1>
</div>

<div class="container">
  <div class="row">
    <p class="text-center">
      
      <a href="http://presidioworkshops.com/workshops/strangling_the_monolith">Return to Workshop</a>
    </p>
    
    








<nav>
  <ul class="pager">
    
    
    <li class="previous">
      <a href="http://presidioworkshops.com/workshops/strangling_the_monolith/login_tour_oc/">&larr; Previous: Lab - Login &amp; Tour of OpenShift</a>
    </li>
    
    
    
    
    <li class="next">
      <a href="http://presidioworkshops.com/workshops/strangling_the_monolith/lab2/">Next: Lab - Strangle Your Monolith &rarr;</a>
    </li>
    
    
  </ul>
</nav>

    <h1 id="fast-moving-monolith">FAST-MOVING MONOLITH</h1>
<ul>
<li>Large organizations have a tremendous amount of resources invested in existing monolith applications</li>
<li>Looking for a sane way to capture the benefits of containers and orchestration without having to complete rewrite</li>
<li>OpenShift provides the platform for their existing investment with the benefit of a path forward for microservice based apps in the future</li>
</ul>
<h1 id="fast-moving-monolith-advantages">FAST-MOVING MONOLITH ADVANTAGES</h1>
<ul>
<li>Easier to develop since all dependencies are included</li>
<li>Single code base for teams to work on</li>
<li>No API backwards compatibility issues since all logic is packaged with the application</li>
<li>Single deployable unit</li>
</ul>
<h1 id="step-1">Step 1</h1>
<ul>
<li>In this lab, the coolstore monolith will be built and deployed to OpenShift from your local workstation demonstrating a typical Java application developer workflow</li>
<li>A sample pipeline is included which will be used to deploy across dev and prod environment</li>
</ul>
<blockquote>
<p>First, deploy the coolstore monolith dev project (don’t forget to include -b app-partner when you run git clone - this is the branch in use for this lab!):</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir ~/coolstore
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd ~/coolstore
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone -b app-partner https://github.com/epe105/monolith
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd monolith
</code></pre></div><!-- raw HTML omitted -->
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>Please update <code>&lt;USERNAME&gt;</code> below with your assigned username</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc new-project coolstore-&lt;USERNAME&gt;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc process -f src/main/openshift/template.json | oc create -f -
</code></pre></div><h1 id="step-2">Step 2</h1>
<blockquote>
<p>Notice there is no deployment yet as there is no build yet:</p>
</blockquote>
<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="collapsed">
      
        OpenShift Dev Deployment
      </a>
    </h4>
  </div>
  
  <div id="collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <p><!-- raw HTML omitted --></p>

    </div>
  </div>
</div>


</div>

<h1 id="step-3">Step 3</h1>
<ul>
<li>A number of OpenShift objects were created:</li>
<li>A Postgres database deployment, service, and route</li>
<li>A coolstore binary BuildConfig
<ul>
<li>Binary builds accept source code through stdin in later commands (vs. kicking off a build within an OpenShift pod)</li>
</ul>
</li>
<li>Services, Routes and DeploymentConfig for coolstore-dev</li>
<li>Service Accounts and Secrets (for cluster permissions)</li>
</ul>
<blockquote>
<p>Build the coolstore monolith (.war file) locally and deploy into the OpenShift via the binary build:</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd ~/coolstore/monolith
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mvn clean package -Popenshift
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc start-build coolstore --from-file deployments/ROOT.war --follow
</code></pre></div><h1 id="step-4">Step 4</h1>
<ul>
<li>Binary builds still produce Linux container images and are stored into the container registry.</li>
</ul>
<blockquote>
<p>In the web console, navigate to Builds → Images to see the new image created as a result of combining the monolith .war file with the JBoss EAP builder image</p>
</blockquote>
<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="collapsed">
      
        OpenShift Cool Store Build
      </a>
    </h4>
  </div>
  
  <div id="collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <p><!-- raw HTML omitted --></p>

    </div>
  </div>
</div>


</div>

<h1 id="step-5">Step 5</h1>
<blockquote>
<p>Once the deployment is complete, navigate to the application by clicking on its route in the OpenShift web console Overview and exercise the app by adding/removing products to your shopping cart:</p>
</blockquote>
<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="collapsed">
      
        Cool Store UI
      </a>
    </h4>
  </div>
  
  <div id="collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <p><!-- raw HTML omitted --></p>

    </div>
  </div>
</div>


</div>

<h1 id="step-6">Step 6</h1>
<ul>
<li>The app contains an AngularJS web frontend which makes REST calls to its backend (e.g. /services/products)</li>
<li>The app’s backend contains services implement as Stateless and Stateful EJBs backed by JPA entities</li>
<li>The product catalog and inventory are stored together in the database.</li>
</ul>
<blockquote>
<p>Log into the database pod (with postgresql in the pod name) and inspect the values stored (you will need to copy/paste the password from the POSTGRESQL_PASSWORD environment variable when running the psql command):</p>
</blockquote>
<blockquote>
<p>Make note of POSTGRESQL_PASSWORD</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc env dc/coolstore-dev-postgresql --list       <span style="color:#75715e"># copy value of POSTGRESQL_PASSWORD to clipboard</span>
</code></pre></div><blockquote>
<p>Make note of postgresql pod</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc get pods
</code></pre></div><blockquote>
<p>oc rsh into postresql pod</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc rsh coolstore-dev-postgresql-1-3rfuw
sh-4.2$ psql -h $HOSTNAME -d $POSTGRESQL_DATABASE -U $POSTGRESQL_USER
Password <span style="color:#66d9ef">for</span> user userV31:XXXXXXXX
psql <span style="color:#f92672">(</span>9.5.4<span style="color:#f92672">)</span>
Type <span style="color:#e6db74">&#34;help&#34;</span> <span style="color:#66d9ef">for</span> help.

monolith<span style="color:#f92672">=</span>&gt; <span style="color:#66d9ef">select</span> * from INVENTORY;
monolith<span style="color:#f92672">=</span>&gt; <span style="color:#66d9ef">select</span> * from PRODUCT_CATALOG;

</code></pre></div><blockquote>
<p>Exit out of psql and then the postgresql pod</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">monolith<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">\q</span>
sh-4.2$ exit
exit
</code></pre></div><h1 id="step-7">Step 7</h1>
<ul>
<li>The coolstore-dev build and deployment is responsible for building new versions of the app after code changes and deploying them to the development environment.</li>
<li>Production environments will ideally use different projects, and even different nodes in an OpenShift cluster. For simplicity we have dev and prod in the same project.</li>
</ul>
<blockquote>
<p>Create the production deployment objects that will be used to promote builds from dev to prod using the supplied CI/CD pipeline:</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc process -f ~/coolstore/monolith/src/main/openshift/template-prod.json | oc create -f -
</code></pre></div><h1 id="step-8">Step 8</h1>
<ul>
<li>Several types of OpenShift objects are created:
<ul>
<li>A production Postgres database deployment, service, and route</li>
<li>Services, Routes and DeploymentConfig for coolstore-prod (production env)</li>
<li>Service Accounts and Secrets (for cluster permissions)</li>
<li>A CI/CD server (Jenkins)</li>
<li>A CI/CD pipeline</li>
</ul>
</li>
<li>Notice that no deployment occurs for the production version of the app.</li>
<li>Deployment of the production app occurs as a result of images from the dev environment being appropriately tagged.</li>
</ul>
<blockquote>
<p>Inspect the pipeline and observe the steps it executes during the pipeline run. Notice at the end of the script, the latest coolstore image is tagged with :prod, triggering a production deployment:</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc get bc/monolith-pipeline -o yaml
...
          openshiftTag<span style="color:#f92672">(</span>sourceStream: <span style="color:#e6db74">&#39;coolstore&#39;</span>, sourceTag: <span style="color:#e6db74">&#39;latest&#39;</span>, namespace: <span style="color:#e6db74">&#39;&#39;</span>, destinationStream: <span style="color:#e6db74">&#39;coolstore&#39;</span>, destinationTag: <span style="color:#e6db74">&#39;prod&#39;</span>, destinationNamespace: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">)</span>
...

</code></pre></div><h1 id="step-9">Step 9</h1>
<blockquote>
<p>Wait for the jenkins service to be completely available, then execute the pipeline by navigating to Builds→ Pipelines and click on Start Pipeline next to the Monolith Pipeline:</p>
</blockquote>
<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="collapsed">
      
        Monolith Pipeline
      </a>
    </h4>
  </div>
  
  <div id="collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <p><!-- raw HTML omitted --></p>

    </div>
  </div>
</div>


</div>

<h1 id="step-10">Step 10</h1>
<ul>
<li>Observe the pipeline as it executes its stages</li>
<li>Once the pipeline is complete, the production app is deployed.</li>
<li>Typically there would be a human approval step before going live</li>
<li>Pipelines are also good at executing advanced deployment strategies (blue/green, canary)</li>
</ul>
<blockquote>
<p>Return to the Overview page, wait for the deployment to complete, then click on the route for the coolstore-prod deployment to test the production app (identical to coolstore-dev).</p>
</blockquote>
<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="collapsed">
      
        Pipelines
      </a>
    </h4>
  </div>
  
  <div id="collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <p><!-- raw HTML omitted --></p>

    </div>
  </div>
</div>


</div>

<h1 id="step-11">Step 11</h1>
<blockquote>
<p>You should now have two identical copies of the app deployed, along with two databases:</p>
</blockquote>
<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="collapsed">
      
        OpenShift Dev and Prod Container Deployment
      </a>
    </h4>
  </div>
  
  <div id="collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <p><!-- raw HTML omitted --></p>

    </div>
  </div>
</div>


</div>

<h1 id="step-12">Step 12</h1>
<blockquote>
<p>Scale down the coolstore-dev environment by clicking the down arrow next to the coolstore-dev and coolstore-dev-postgresql pods:</p>
</blockquote>
<div class="panel-group">
  

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      
      <a data-toggle="collapse" href="#collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="collapsed">
      
        Scale Down Dev Containers
      </a>
    </h4>
  </div>
  
  <div id="collapse1917db1bafe5ed15e5fa3f0f61a48c63" class="panel-collapse collapse ">
  
    <div class="panel-body">
       <p><!-- raw HTML omitted --></p>

    </div>
  </div>
</div>


</div>

<!-- raw HTML omitted -->
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>If your build pipeline fails to start, you can manually tag the images:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ oc tag coolstore:latest coolstore:prod
</code></pre></div><!-- raw HTML omitted -->


    








<nav>
  <ul class="pager">
    
    
    <li class="previous">
      <a href="http://presidioworkshops.com/workshops/strangling_the_monolith/login_tour_oc/">&larr; Previous: Lab - Login &amp; Tour of OpenShift</a>
    </li>
    
    
    
    
    <li class="next">
      <a href="http://presidioworkshops.com/workshops/strangling_the_monolith/lab2/">Next: Lab - Strangle Your Monolith &rarr;</a>
    </li>
    
    
  </ul>
</nav>

    <p class="text-center">
      
      <a href="http://presidioworkshops.com/workshops/strangling_the_monolith">Return to Workshop</a>
    </p>
  </div>
</div>

    <div id="page-footer" class="container">
      <p class="text-center">
        Copyright &copy; 2024 Presidio, Inc.
      </p>
    </div>
    <script type="text/javascript">
      if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
      }
    </script>
  </body>
</html>

